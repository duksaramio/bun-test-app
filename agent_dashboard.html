<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Help Desk - Agent Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .nav-link-active {
            background-color: #3730a3; /* bg-indigo-800 */
            color: white;
        }
        .nav-link {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #e5e7eb; /* bg-gray-200 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #9ca3af; /* bg-gray-400 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: #ffffff;
            margin: 5% auto; /* Adjusted margin for potentially taller modal */
            padding: 1.5rem 2rem; /* Slightly adjusted padding */
            border-radius: 0.5rem; /* rounded-lg */
            width: 90%;
            max-width: 700px; /* Increased max-width for agent modal */
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }
        .modal-close-button:hover {
            color: #ef4444; /* red-500 */
        }
        /* Tab styling for comments in modal */
        .comment-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: border-color 0.3s, color 0.3s;
        }
        .comment-tab-active {
            border-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
            font-weight: 500;
        }
        .tab-content { display: none; }
        .tab-content-active { display: block; }

        /* Styling for form elements within modal */
        .modal-form-label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #374151; /* text-gray-700 */
        }
        .modal-form-input, .modal-form-select, .modal-form-textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .modal-form-input:focus, .modal-form-select:focus, .modal-form-textarea:focus {
            outline: none;
            border-color: #4f46e5; /* focus:border-indigo-500 */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3); /* focus:ring-indigo-500 with opacity */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                     <svg class="h-8 w-8 text-indigo-700 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25m18 0A2.25 2.25 0 0 0 18.75 3H5.25A2.25 2.25 0 0 0 3 5.25m18 0V12a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 12V5.25" />
                    </svg>
                    <span class="font-bold text-xl text-gray-800">IT Help Desk <span class="text-indigo-700 font-semibold">Agent Portal</span></span>
                </div>
                <div class="flex items-center">
                    <span class="text-gray-600 mr-4">Welcome, <strong id="agentName" class="font-medium">Agent</strong>!</span>
                    <button class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <nav class="bg-indigo-600 shadow-lg">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-center space-x-1 sm:space-x-2">
                <button data-target="agentDashboardHome" class="nav-link nav-link-active py-3 px-3 sm:px-4 text-xs sm:text-sm font-medium text-white hover:bg-indigo-700 rounded-t-md">Home</button>
                <button data-target="myAssignedTickets" class="nav-link py-3 px-3 sm:px-4 text-xs sm:text-sm font-medium text-white hover:bg-indigo-700 rounded-t-md">My Tickets</button>
                <button data-target="teamTickets" class="nav-link py-3 px-3 sm:px-4 text-xs sm:text-sm font-medium text-white hover:bg-indigo-700 rounded-t-md">Team Tickets</button>
                <button data-target="unassignedQueue" class="nav-link py-3 px-3 sm:px-4 text-xs sm:text-sm font-medium text-white hover:bg-indigo-700 rounded-t-md">Unassigned</button>
                <button data-target="knowledgeBaseAgent" class="nav-link py-3 px-3 sm:px-4 text-xs sm:text-sm font-medium text-white hover:bg-indigo-700 rounded-t-md">Knowledge Base</button>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
        <section id="agentDashboardHome" class="content-section bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Agent Dashboard Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-sky-50 p-6 rounded-lg shadow hover:shadow-md transition-shadow">
                    <h3 class="text-lg font-medium text-sky-700">My Open Tickets</h3>
                    <p class="text-3xl font-bold text-sky-600 mt-2" id="statMyOpenTickets">0</p>
                </div>
                <div class="bg-teal-50 p-6 rounded-lg shadow hover:shadow-md transition-shadow">
                    <h3 class="text-lg font-medium text-teal-700">Team's Open Tickets</h3>
                    <p class="text-3xl font-bold text-teal-600 mt-2" id="statTeamOpenTickets">0</p>
                </div>
                <div class="bg-amber-50 p-6 rounded-lg shadow hover:shadow-md transition-shadow">
                    <h3 class="text-lg font-medium text-amber-700">New Unassigned Tickets</h3>
                    <p class="text-3xl font-bold text-amber-600 mt-2" id="statUnassignedTickets">0</p>
                </div>
            </div>
            </section>

        <section id="myAssignedTickets" class="content-section hidden bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">My Assigned Tickets</h2>
            <div id="myAssignedTicketsList" class="overflow-x-auto custom-scrollbar"></div>
            <p id="noMyAssignedTicketsMessage" class="text-center text-gray-500 py-8 hidden">You have no tickets assigned to you.</p>
        </section>

        <section id="teamTickets" class="content-section hidden bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Team Tickets (<span id="agentTeamName"></span>)</h2>
            <div id="teamTicketsList" class="overflow-x-auto custom-scrollbar"></div>
            <p id="noTeamTicketsMessage" class="text-center text-gray-500 py-8 hidden">No open tickets assigned to your team currently.</p>
        </section>

        <section id="unassignedQueue" class="content-section hidden bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Unassigned Ticket Queue</h2>
            <div id="unassignedQueueList" class="overflow-x-auto custom-scrollbar"></div>
            <p id="noUnassignedTicketsMessage" class="text-center text-gray-500 py-8 hidden">There are no unassigned tickets in the queue.</p>
        </section>

        <section id="knowledgeBaseAgent" class="content-section hidden bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Knowledge Base</h2>
            <div class="mb-6">
                <label for="kbSearchAgent" class="block text-sm font-medium text-gray-700 mb-1">Search Articles</label>
                <div class="relative">
                    <input type="search" name="kbSearchAgent" id="kbSearchAgent" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Search by keyword...">
                     <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                    </div>
                </div>
            </div>
            <div id="kbArticlesListAgent" class="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2"></div>
            <p id="noKbArticlesMessageAgent" class="text-center text-gray-500 py-8 hidden">No articles found.</p>
        </section>
    </main>

    <footer class="bg-gray-800 text-white text-center p-4 mt-auto">
        <p class="text-sm">&copy; <span id="currentYearAgent"></span> Your IT Department - Agent Portal. All rights reserved.</p>
    </footer>

    <div id="agentDetailsModal" class="modal">
        <div class="modal-content custom-scrollbar max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                <h3 id="agentModalTitle" class="text-xl font-semibold text-gray-800">Ticket Details</h3>
                <button id="agentModalCloseButton" class="text-gray-400 hover:text-gray-600 modal-close-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="agentModalBody" class="text-gray-700 space-y-4">
                </div>
        </div>
    </div>

    <script>
        // --- Mock Data ---
        const mockAgentUser = {
            userId: 201,
            fullName: "Support Sam",
            email: "sam.support@example.com",
            role_id: 2, // Agent
            teamIds: [1] // Member of Alpha Support Team
        };

        const mockOtherAgents = [
            { userId: 202, fullName: "Technician Tina", teamIds: [1, 2] },
            { userId: 203, fullName: "Helper Harry", teamIds: [2] }
        ];
        const allMockAgents = [mockAgentUser, ...mockOtherAgents];


        const mockTeams = [
            { team_id: 1, team_name: "Alpha Support Team", description: "General support issues." },
            { team_id: 2, team_name: "Beta Technical Team", description: "Advanced technical problems." }
        ];

        const mockEndUsers = [
            { userId: 101, fullName: "Jane Doe", email: "jane.doe@example.com", role_id: 1 },
            { userId: 102, fullName: "John Smith", email: "john.smith@example.com", role_id: 1 },
            { userId: 103, fullName: "Alice Brown", email: "alice.brown@example.com", role_id: 1 }
        ];
        const allMockUsers = [...mockEndUsers, ...allMockAgents];


        const mockTicketStatuses = [
            { status_id: 1, status_name: 'Open', is_closing_status: 0 },
            { status_id: 2, status_name: 'In Progress', is_closing_status: 0 },
            { status_id: 3, status_name: 'Pending User Reply', is_closing_status: 0 },
            { status_id: 4, status_name: 'Resolved', is_closing_status: 1 },
            { status_id: 5, status_name: 'Closed', is_closing_status: 1 },
            { status_id: 6, status_name: 'On Hold', is_closing_status: 0 },
        ];

        const mockTicketPriorities = [
            { priority_id: 1, priority_name: 'Urgent', sort_order: 1 },
            { priority_id: 2, priority_name: 'High', sort_order: 2 },
            { priority_id: 3, priority_name: 'Medium', sort_order: 3 },
            { priority_id: 4, priority_name: 'Low', sort_order: 4 }
        ];

        const mockTicketCategories = [
            { category_id: 1, category_name: 'Hardware Issue' },
            { category_id: 2, category_name: 'Software Problem' },
            { category_id: 3, category_name: 'Network Access' },
            { category_id: 4, category_name: 'Password Reset' },
            { category_id: 5, category_name: 'Account Management' },
            { category_id: 6, category_name: 'Service Request'}
        ];

        let mockTickets = [
            // Assigned to Support Sam (mockAgentUser)
            { ticket_id: 2024001, subject: 'Laptop screen flickering', description: 'My laptop screen started flickering this morning. It happens intermittently.', status_id: 2, priority_id: 2, category_id: 1, requester_id: 101, assigned_agent_id: 201, assigned_team_id: 1, created_at: '2024-05-01T10:00:00Z', updated_at: '2024-05-03T14:30:00Z', comments: [{user_id: 201, text: 'Checked display drivers, issue persists. Will investigate hardware.', is_internal: true, created_at: '2024-05-03T14:30:00Z'}, {user_id: 101, text: 'Any updates on this?', is_internal: false, created_at: '2024-05-02T10:00:00Z'}]},
            { ticket_id: 2024005, subject: 'Need access to Project Phoenix folder', description: 'I require read/write access to the Project Phoenix shared folder for my new assignment.', status_id: 1, priority_id: 3, category_id: 3, requester_id: 102, assigned_agent_id: 201, assigned_team_id: 1, created_at: '2024-05-04T11:00:00Z', updated_at: '2024-05-04T11:00:00Z', comments: []},
            // Assigned to Alpha Support Team (mockAgentUser's team) but not specific agent
            { ticket_id: 2024006, subject: 'Printer not working - HR Department', description: 'The main printer in the HR department is not responding. Error code E255 displayed.', status_id: 1, priority_id: 1, category_id: 1, requester_id: 103, assigned_agent_id: null, assigned_team_id: 1, created_at: '2024-05-05T09:00:00Z', updated_at: '2024-05-05T09:00:00Z', comments: []},
            // Unassigned
            { ticket_id: 2024002, subject: 'Cannot access shared drive', description: 'I am unable to access the marketing shared drive. I get an access denied error.', status_id: 1, priority_id: 3, category_id: 3, requester_id: 101, assigned_agent_id: null, assigned_team_id: null, created_at: '2024-05-03T09:15:00Z', updated_at: '2024-05-03T09:15:00Z', comments: []},
            { ticket_id: 2024007, subject: 'Software installation request - "Inkscape"', description: 'Requesting installation of Inkscape vector graphics editor for design tasks.', status_id: 1, priority_id: 4, category_id: 6, requester_id: 102, assigned_agent_id: null, assigned_team_id: null, created_at: '2024-05-06T10:00:00Z', updated_at: '2024-05-06T10:00:00Z', comments: []},
            // Resolved/Closed (for historical context, not typically in open queues)
            { ticket_id: 2024003, subject: 'Request for new software license (Photoshop)', description: 'I need a license for Adobe Photoshop for a new project.', status_id: 5, priority_id: 4, category_id: 2, requester_id: 101, assigned_agent_id: 202, assigned_team_id: 1, created_at: '2024-04-20T15:00:00Z', updated_at: '2024-04-25T10:00:00Z', resolved_at: '2024-04-25T10:00:00Z', closed_at: '2024-04-26T10:00:00Z', comments: [{user_id: 202, text: 'License approved and assigned.', is_internal: false, created_at: '2024-04-25T10:00:00Z'}]},
        ];

        const mockKbArticles = [ // From KB_Articles table (same as user dashboard for now)
            { article_id: 101, title: 'How to Reset Your Password', content: '<p>If you have forgotten your password, you can reset it by following these steps:</p><ol><li>Go to the login page.</li><li>Click on the "Forgot Password" link.</li><li>Enter your email address and follow the instructions sent to your inbox.</li></ol><p>If you still face issues, please contact IT support.</p>', kb_category_id: 4, tags: ['password', 'reset'] },
            { article_id: 102, title: 'Setting Up VPN Access', content: '<p>To access company resources remotely, you need to set up the VPN...</p>', kb_category_id: 3, tags: ['vpn', 'network'] },
        ];

        // --- Utility Functions ---
        const getStatusName = (id) => mockTicketStatuses.find(s => s.status_id === id)?.status_name || 'Unknown';
        const getPriorityName = (id) => mockTicketPriorities.find(p => p.priority_id === id)?.priority_name || 'Unknown';
        const getCategoryName = (id) => mockTicketCategories.find(c => c.category_id === id)?.category_name || 'Unknown';
        const getUserFullName = (id) => allMockUsers.find(u => u.userId === id)?.fullName || 'Unknown User';
        const getTeamName = (id) => mockTeams.find(t => t.team_id === id)?.team_name || 'Unassigned';
        const getKbCategoryName = (id) => mockTicketCategories.find(c => c.category_id === id)?.category_name || 'Uncategorized';

        // --- DOM Elements ---
        const contentSections = document.querySelectorAll('.content-section');
        const navLinks = document.querySelectorAll('nav button[data-target]');
        // Ticket list containers
        const myAssignedTicketsList = document.getElementById('myAssignedTicketsList');
        const noMyAssignedTicketsMessage = document.getElementById('noMyAssignedTicketsMessage');
        const teamTicketsList = document.getElementById('teamTicketsList');
        const noTeamTicketsMessage = document.getElementById('noTeamTicketsMessage');
        const unassignedQueueList = document.getElementById('unassignedQueueList');
        const noUnassignedTicketsMessage = document.getElementById('noUnassignedTicketsMessage');
        // KB Agent
        const kbSearchAgentInput = document.getElementById('kbSearchAgent');
        const kbArticlesListAgent = document.getElementById('kbArticlesListAgent');
        const noKbArticlesMessageAgent = document.getElementById('noKbArticlesMessageAgent');
        // Modal Agent
        const agentModal = document.getElementById('agentDetailsModal');
        const agentModalTitle = document.getElementById('agentModalTitle');
        const agentModalBody = document.getElementById('agentModalBody');
        const agentModalCloseButton = document.getElementById('agentModalCloseButton');


        // --- Initialization ---
        function initializeAgentDashboard() {
            document.getElementById('agentName').textContent = mockAgentUser.fullName;
            const agentTeam = mockTeams.find(t => mockAgentUser.teamIds.includes(t.team_id));
            document.getElementById('agentTeamName').textContent = agentTeam ? agentTeam.team_name : 'No Team';
            document.getElementById('currentYearAgent').textContent = new Date().getFullYear();

            showSection('agentDashboardHome');
            updateActiveNav('agentDashboardHome');
            updateAgentDashboardStats();

            renderMyAssignedTickets();
            renderTeamTickets();
            renderUnassignedQueue();
            renderKbArticlesAgent();


            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const targetId = link.dataset.target;
                    showSection(targetId);
                    updateActiveNav(targetId);
                });
            });
            
            kbSearchAgentInput.addEventListener('input', () => renderKbArticlesAgent(kbSearchAgentInput.value.toLowerCase()));

            agentModalCloseButton.addEventListener('click', closeAgentModal);
            window.addEventListener('click', (event) => {
                if (event.target === agentModal) closeAgentModal();
            });
        }

        // --- Navigation & Section Handling ---
        function showSection(sectionId) {
            contentSections.forEach(section => section.classList.add('hidden'));
            document.getElementById(sectionId)?.classList.remove('hidden');
        }

        function updateActiveNav(targetId) {
            navLinks.forEach(navLink => {
                navLink.classList.toggle('nav-link-active', navLink.dataset.target === targetId);
            });
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function getStatusBadgeClass(statusId) {
            const statusName = getStatusName(statusId).toLowerCase();
            if (statusName.includes('resolved') || statusName.includes('closed')) return 'bg-green-100 text-green-800';
            if (statusName.includes('progress')) return 'bg-blue-100 text-blue-800';
            if (statusName.includes('pending')) return 'bg-yellow-100 text-yellow-800';
            if (statusName.includes('hold')) return 'bg-orange-100 text-orange-800';
            return 'bg-gray-100 text-gray-800';
        }

        // --- Ticket Table Rendering ---
        function createTicketTable(tickets, containerElement, noItemsMessageElement, context) {
            containerElement.innerHTML = ''; // Clear
            if (tickets.length === 0) {
                noItemsMessageElement.classList.remove('hidden');
                return;
            }
            noItemsMessageElement.classList.add('hidden');

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            table.innerHTML = `
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requester</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                        ${context !== 'myAssigned' ? '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned Agent</th>' : ''}
                        ${context !== 'team' && context !== 'myAssigned' ? '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned Team</th>' : ''}
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200"></tbody>
            `;
            const tbody = table.querySelector('tbody');
            tickets.forEach(ticket => {
                const row = tbody.insertRow();
                row.className = "hover:bg-gray-50 transition-colors";
                let assignedAgentHTML = context !== 'myAssigned' ? `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${ticket.assigned_agent_id ? getUserFullName(ticket.assigned_agent_id) : 'N/A'}</td>` : '';
                let assignedTeamHTML = context !== 'team' && context !== 'myAssigned' ? `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${ticket.assigned_team_id ? getTeamName(ticket.assigned_team_id) : 'N/A'}</td>` : '';

                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${ticket.ticket_id}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 max-w-xs truncate" title="${ticket.subject}">${ticket.subject}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${getUserFullName(ticket.requester_id)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(ticket.status_id)}">${getStatusName(ticket.status_id)}</span></td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${getPriorityName(ticket.priority_id)}</td>
                    ${assignedAgentHTML}
                    ${assignedTeamHTML}
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(ticket.created_at)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewAgentTicketDetails(${ticket.ticket_id})" class="text-indigo-600 hover:text-indigo-900">View/Edit</button>
                        ${ (context === 'unassigned' || (context === 'team' && !ticket.assigned_agent_id)) ? `<button onclick="assignTicketToSelf(${ticket.ticket_id})" class="ml-2 text-green-600 hover:text-green-900">Assign to Me</button>` : ''}
                    </td>
                `;
            });
            containerElement.appendChild(table);
        }

        function renderMyAssignedTickets() {
            const tickets = mockTickets.filter(t => t.assigned_agent_id === mockAgentUser.userId && !mockTicketStatuses.find(s => s.status_id === t.status_id)?.is_closing_status).sort((a,b) => mockTicketPriorities.find(p=>p.priority_id === a.priority_id).sort_order - mockTicketPriorities.find(p=>p.priority_id === b.priority_id).sort_order || new Date(a.created_at) - new Date(b.created_at) );
            createTicketTable(tickets, myAssignedTicketsList, noMyAssignedTicketsMessage, 'myAssigned');
        }

        function renderTeamTickets() {
            const tickets = mockTickets.filter(t => mockAgentUser.teamIds.includes(t.assigned_team_id) && !t.assigned_agent_id && !mockTicketStatuses.find(s => s.status_id === t.status_id)?.is_closing_status).sort((a,b) => mockTicketPriorities.find(p=>p.priority_id === a.priority_id).sort_order - mockTicketPriorities.find(p=>p.priority_id === b.priority_id).sort_order || new Date(a.created_at) - new Date(b.created_at) );
            createTicketTable(tickets, teamTicketsList, noTeamTicketsMessage, 'team');
        }

        function renderUnassignedQueue() {
            const tickets = mockTickets.filter(t => !t.assigned_agent_id && !t.assigned_team_id && !mockTicketStatuses.find(s => s.status_id === t.status_id)?.is_closing_status).sort((a,b) => mockTicketPriorities.find(p=>p.priority_id === a.priority_id).sort_order - mockTicketPriorities.find(p=>p.priority_id === b.priority_id).sort_order || new Date(a.created_at) - new Date(b.created_at) );
            createTicketTable(tickets, unassignedQueueList, noUnassignedTicketsMessage, 'unassigned');
        }
        
        function refreshAllTicketViews() {
            renderMyAssignedTickets();
            renderTeamTickets();
            renderUnassignedQueue();
            updateAgentDashboardStats();
        }

        // --- KB Rendering (Agent) ---
        function renderKbArticlesAgent(searchTerm = '') {
            kbArticlesListAgent.innerHTML = '';
            const filteredArticles = mockKbArticles.filter(article =>
                article.title.toLowerCase().includes(searchTerm) ||
                article.content.toLowerCase().includes(searchTerm) ||
                (article.tags && article.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
            );

            if (filteredArticles.length === 0) {
                noKbArticlesMessageAgent.classList.remove('hidden');
                return;
            }
            noKbArticlesMessageAgent.classList.add('hidden');

            filteredArticles.forEach(article => {
                const articleElement = document.createElement('div');
                articleElement.className = 'p-4 border border-gray-200 rounded-lg hover:shadow-md transition-shadow cursor-pointer';
                articleElement.innerHTML = `
                    <h4 class="text-lg font-semibold text-indigo-700 hover:text-indigo-800">${article.title}</h4>
                    <p class="text-sm text-gray-600 mt-1">Category: ${getKbCategoryName(article.kb_category_id)}</p>
                    <p class="text-sm text-gray-500 mt-2 truncate">${stripHtml(article.content).substring(0,150)}...</p>
                `;
                articleElement.addEventListener('click', () => viewAgentKbArticleDetails(article.article_id));
                kbArticlesListAgent.appendChild(articleElement);
            });
        }
        function stripHtml(html) {
           let tmp = document.createElement("DIV");
           tmp.innerHTML = html;
           return tmp.textContent || tmp.innerText || "";
        }


        // --- Stats Update ---
        function updateAgentDashboardStats() {
            document.getElementById('statMyOpenTickets').textContent = mockTickets.filter(t => t.assigned_agent_id === mockAgentUser.userId && !mockTicketStatuses.find(s => s.status_id === t.status_id)?.is_closing_status).length;
            document.getElementById('statTeamOpenTickets').textContent = mockTickets.filter(t => mockAgentUser.teamIds.includes(t.assigned_team_id) && !t.assigned_agent_id && !mockTicketStatuses.find(s => s.status_id === t.status_id)?.is_closing_status).length;
            document.getElementById('statUnassignedTickets').textContent = mockTickets.filter(t => !t.assigned_agent_id && !t.assigned_team_id && !mockTicketStatuses.find(s => s.status_id === t.status_id)?.is_closing_status).length;
        }

        // --- Agent Modal ---
        function openAgentModal(title, contentHtml) {
            agentModalTitle.textContent = title;
            agentModalBody.innerHTML = contentHtml;
            agentModal.style.display = 'flex';
            document.body.classList.add('overflow-hidden');
        }

        function closeAgentModal() {
            agentModal.style.display = 'none';
            agentModalTitle.textContent = '';
            agentModalBody.innerHTML = '';
            document.body.classList.remove('overflow-hidden');
        }
        
        window.assignTicketToSelf = function(ticketId) {
            const ticket = mockTickets.find(t => t.ticket_id === ticketId);
            if (ticket) {
                ticket.assigned_agent_id = mockAgentUser.userId;
                if (!ticket.assigned_team_id && mockAgentUser.teamIds.length > 0) {
                     ticket.assigned_team_id = mockAgentUser.teamIds[0]; // Assign to agent's primary team
                }
                ticket.updated_at = new Date().toISOString();
                if (ticket.status_id === 1) ticket.status_id = 2; // Open -> In Progress
                
                alert(`Ticket #${ticketId} assigned to you.`); // Simple notification
                refreshAllTicketViews();
            }
        }

        window.viewAgentTicketDetails = function(ticketId) {
            const ticket = mockTickets.find(t => t.ticket_id === ticketId);
            if (!ticket) return;

            // Options for dropdowns
            const statusOptions = mockTicketStatuses.map(s => `<option value="${s.status_id}" ${ticket.status_id === s.status_id ? 'selected' : ''}>${s.status_name}</option>`).join('');
            const priorityOptions = mockTicketPriorities.map(p => `<option value="${p.priority_id}" ${ticket.priority_id === p.priority_id ? 'selected' : ''}>${p.priority_name}</option>`).join('');
            const categoryOptions = mockTicketCategories.map(c => `<option value="${c.category_id}" ${ticket.category_id === c.category_id ? 'selected' : ''}>${c.category_name}</option>`).join('');
            const agentOptions = `<option value="">Unassign</option>` + allMockAgents.map(a => `<option value="${a.userId}" ${ticket.assigned_agent_id === a.userId ? 'selected' : ''}>${a.fullName}</option>`).join('');
            const teamOptions = `<option value="">Unassign</option>` + mockTeams.map(t => `<option value="${t.team_id}" ${ticket.assigned_team_id === t.team_id ? 'selected' : ''}>${t.team_name}</option>`).join('');

            // Comments
            let commentsHtml = '<div class="mt-3 border-t pt-3">';
            commentsHtml += `
                <div class="flex border-b mb-3">
                    <button class="comment-tab comment-tab-active" onclick="showCommentTab(this, 'publicComments${ticket.ticket_id}')">Public Reply</button>
                    <button class="comment-tab" onclick="showCommentTab(this, 'internalNotes${ticket.ticket_id}')">Internal Notes</button>
                </div>
                <div id="publicComments${ticket.ticket_id}" class="tab-content tab-content-active space-y-2 max-h-40 overflow-y-auto custom-scrollbar pr-2">`;
            ticket.comments.filter(c => !c.is_internal).sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).forEach(c => {
                commentsHtml += `<div class="bg-blue-50 p-2 rounded text-xs"><p>${c.text}</p><p class="text-gray-500">By: ${getUserFullName(c.user_id)} on ${formatDate(c.created_at)}</p></div>`;
            });
            if (ticket.comments.filter(c => !c.is_internal).length === 0) commentsHtml += `<p class="text-xs text-gray-500">No public replies yet.</p>`
            commentsHtml += `</div>`;

            commentsHtml += `<div id="internalNotes${ticket.ticket_id}" class="tab-content space-y-2 max-h-40 overflow-y-auto custom-scrollbar pr-2">`;
            ticket.comments.filter(c => c.is_internal).sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).forEach(c => {
                 commentsHtml += `<div class="bg-yellow-50 p-2 rounded text-xs"><p>${c.text}</p><p class="text-gray-500">By: ${getUserFullName(c.user_id)} (Internal) on ${formatDate(c.created_at)}</p></div>`;
            });
             if (ticket.comments.filter(c => c.is_internal).length === 0) commentsHtml += `<p class="text-xs text-gray-500">No internal notes yet.</p>`
            commentsHtml += `</div></div>`;


            const content = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                    <div><strong>ID:</strong> ${ticket.ticket_id}</div>
                    <div><strong>Requester:</strong> ${getUserFullName(ticket.requester_id)} (${allMockUsers.find(u=>u.userId === ticket.requester_id)?.email || 'N/A'})</div>
                    <div class="md:col-span-2"><strong>Subject:</strong> ${ticket.subject}</div>
                    <div class="md:col-span-2 p-3 bg-gray-50 border border-gray-200 rounded-md text-xs">
                        <strong>Description:</strong><br>${ticket.description || 'N/A'}
                    </div>

                    <div><label for="ticketStatusAgent" class="modal-form-label">Status:</label><select id="ticketStatusAgent" class="modal-form-select text-sm">${statusOptions}</select></div>
                    <div><label for="ticketPriorityAgent" class="modal-form-label">Priority:</label><select id="ticketPriorityAgent" class="modal-form-select text-sm">${priorityOptions}</select></div>
                    <div><label for="ticketCategoryAgent" class="modal-form-label">Category:</label><select id="ticketCategoryAgent" class="modal-form-select text-sm">${categoryOptions}</select></div>
                    <div><label for="ticketAssignedAgent" class="modal-form-label">Assigned Agent:</label><select id="ticketAssignedAgent" class="modal-form-select text-sm">${agentOptions}</select></div>
                    <div><label for="ticketAssignedTeam" class="modal-form-label">Assigned Team:</label><select id="ticketAssignedTeam" class="modal-form-select text-sm">${teamOptions}</select></div>
                    <div><strong>Created:</strong> ${formatDate(ticket.created_at)}</div>
                    <div><strong>Last Updated:</strong> ${formatDate(ticket.updated_at)}</div>
                    ${ticket.resolved_at ? `<div><strong>Resolved:</strong> ${formatDate(ticket.resolved_at)}</div>` : ''}
                    ${ticket.closed_at ? `<div><strong>Closed:</strong> ${formatDate(ticket.closed_at)}</div>` : ''}
                </div>

                ${commentsHtml}

                <div class="mt-4 border-t pt-4">
                    <h4 class="font-semibold text-gray-700 mb-2 text-sm">Add New Comment / Note:</h4>
                    <textarea id="newCommentTextAgent" rows="3" class="modal-form-textarea text-sm" placeholder="Type your comment..."></textarea>
                    <div class="flex items-center justify-between mt-2">
                        <div>
                            <input type="checkbox" id="isInternalNote" class="mr-1 rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <label for="isInternalNote" class="text-xs text-gray-600">Internal Note (not visible to requester)</label>
                        </div>
                        <button onclick="addCommentToTicketAgent(${ticket.ticket_id})" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-1.5 px-3 rounded-md text-xs">Add Comment</button>
                    </div>
                </div>
                 <div class="mt-4 border-t pt-4 flex justify-end">
                    <button onclick="updateTicketDetailsAgent(${ticket.ticket_id})" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md text-sm">Save Changes</button>
                </div>
            `;
            openAgentModal(`Ticket #${ticket.ticket_id} - ${ticket.subject}`, content);
        }

        window.showCommentTab = function(buttonEl, tabId) {
            const tabContainer = buttonEl.closest('.flex');
            tabContainer.querySelectorAll('.comment-tab').forEach(tab => tab.classList.remove('comment-tab-active'));
            buttonEl.classList.add('comment-tab-active');

            const contentContainer = buttonEl.closest('.border-t');
            contentContainer.querySelectorAll('.tab-content').forEach(content => content.classList.remove('tab-content-active'));
            document.getElementById(tabId).classList.add('tab-content-active');
        }
        
        window.addCommentToTicketAgent = function(ticketId) {
            const text = document.getElementById('newCommentTextAgent').value;
            const isInternal = document.getElementById('isInternalNote').checked;
            if (!text.trim()) { alert("Comment cannot be empty."); return; }

            const ticket = mockTickets.find(t => t.ticket_id === ticketId);
            if (ticket) {
                ticket.comments.push({
                    user_id: mockAgentUser.userId,
                    text: text,
                    is_internal: isInternal,
                    created_at: new Date().toISOString()
                });
                ticket.updated_at = new Date().toISOString();
                document.getElementById('newCommentTextAgent').value = ''; // Clear textarea
                // Refresh modal to show new comment
                viewAgentTicketDetails(ticketId);
                refreshAllTicketViews(); // Update tables in background
            }
        }

        window.updateTicketDetailsAgent = function(ticketId) {
            const ticket = mockTickets.find(t => t.ticket_id === ticketId);
            if (!ticket) return;

            const oldStatusId = ticket.status_id;
            ticket.status_id = parseInt(document.getElementById('ticketStatusAgent').value);
            ticket.priority_id = parseInt(document.getElementById('ticketPriorityAgent').value);
            ticket.category_id = parseInt(document.getElementById('ticketCategoryAgent').value);
            const newAssignedAgentId = document.getElementById('ticketAssignedAgent').value;
            ticket.assigned_agent_id = newAssignedAgentId ? parseInt(newAssignedAgentId) : null;
            const newAssignedTeamId = document.getElementById('ticketAssignedTeam').value;
            ticket.assigned_team_id = newAssignedTeamId ? parseInt(newAssignedTeamId) : null;
            
            ticket.updated_at = new Date().toISOString();
            
            const newStatus = mockTicketStatuses.find(s => s.status_id === ticket.status_id);
            if (newStatus && newStatus.is_closing_status && !ticket.resolved_at) {
                ticket.resolved_at = new Date().toISOString();
                if (newStatus.status_name.toLowerCase() === 'closed' && !ticket.closed_at) {
                     ticket.closed_at = new Date().toISOString();
                }
            } else if (newStatus && !newStatus.is_closing_status) {
                 ticket.resolved_at = null; // Clear resolved if moved to non-closing status
                 ticket.closed_at = null;  // Clear closed if moved to non-closing status
            }


            alert(`Ticket #${ticketId} updated successfully.`);
            closeAgentModal();
            refreshAllTicketViews();
        }
        
        window.viewAgentKbArticleDetails = function(articleId) {
            const article = mockKbArticles.find(a => a.article_id === articleId);
            if (!article) return;
            const content = `
                <div class="prose prose-sm sm:prose lg:prose-lg xl:prose-xl max-w-none">${article.content}</div>
                <hr class="my-4">
                <p class="text-sm text-gray-600">Category: ${getKbCategoryName(article.kb_category_id)}</p>
                ${article.tags && article.tags.length > 0 ? `<div class="mt-2 text-sm text-gray-500">Tags: ${article.tags.map(tag => `<span class="bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full text-xs">${tag}</span>`).join(' ')}</div>` : ''}
            `;
            openAgentModal(article.title, content);
        };


        // Run initialization
        document.addEventListener('DOMContentLoaded', initializeAgentDashboard);
    </script>

</body>
</html>
