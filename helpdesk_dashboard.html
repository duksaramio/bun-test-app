<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Help Desk - User Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* Active tab styling */
        .nav-link-active {
            background-color: #4f46e5; /* bg-indigo-600 */
            color: white;
        }
        .nav-link {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        /* Custom scrollbar for ticket/article lists if they overflow */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7d2fe; /* indigo-200 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a5b4fc; /* indigo-300 */
        }
        /* Basic modal styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); /* Dim background */
        }
        .modal-content {
            background-color: #ffffff;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 0.5rem; /* rounded-lg */
            width: 90%;
            max-width: 600px; /* md:max-w-2xl */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .modal-close-button {
            transition: color 0.2s ease;
        }
        .modal-close-button:hover {
            color: #dc2626; /* red-600 */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <svg class="h-8 w-8 text-indigo-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6-2.292m0 0V3.75m0 12.15V12m0 0H9m3 0H6m9 0H15m3 0H12m0 0V9m0 3.75m0-3.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm0 0a3 3 0 1 0 6 0 3 3 0 0 0-6 0Z" />
                    </svg>
                    <span class="font-bold text-xl text-gray-800">IT Help Desk</span>
                </div>
                <div class="flex items-center">
                    <span class="text-gray-600 mr-4">Welcome, <strong id="userName" class="font-medium">End User</strong>!</span>
                    <button class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <nav class="bg-indigo-500 shadow-lg">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-center space-x-2 sm:space-x-4">
                <button data-target="dashboardHome" class="nav-link nav-link-active py-3 px-4 text-sm sm:text-base font-medium text-white hover:bg-indigo-700 rounded-t-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1 -mt-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    Home
                </button>
                <button data-target="myTickets" class="nav-link py-3 px-4 text-sm sm:text-base font-medium text-white hover:bg-indigo-700 rounded-t-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1 -mt-1"><path d="M16 2a2 2 0 0 0-2-2H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2Z"></path><path d="M10 6H6"></path><path d="M10 10H6"></path><path d="m18 6 4 4"></path><path d="m18 10-4 4"></path></svg>
                    My Tickets
                </button>
                <button data-target="newTicket" class="nav-link py-3 px-4 text-sm sm:text-base font-medium text-white hover:bg-indigo-700 rounded-t-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1 -mt-1"><path d="M11 12H3"></path><path d="M16 6H3"></path><path d="M16 18H3"></path><path d="M18 9v6"></path><path d="M21 12h-6"></path></svg>
                    Submit New Ticket
                </button>
                <button data-target="knowledgeBase" class="nav-link py-3 px-4 text-sm sm:text-base font-medium text-white hover:bg-indigo-700 rounded-t-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1 -mt-1"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                    Knowledge Base
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
        <section id="dashboardHome" class="content-section bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Dashboard Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-blue-50 p-6 rounded-lg shadow hover:shadow-md transition-shadow">
                    <h3 class="text-lg font-medium text-blue-700">Open Tickets</h3>
                    <p class="text-3xl font-bold text-blue-600 mt-2" id="statOpenTickets">3</p>
                    <p class="text-sm text-blue-500 mt-1">Tickets awaiting action.</p>
                </div>
                <div class="bg-green-50 p-6 rounded-lg shadow hover:shadow-md transition-shadow">
                    <h3 class="text-lg font-medium text-green-700">Resolved Tickets</h3>
                    <p class="text-3xl font-bold text-green-600 mt-2" id="statResolvedTickets">12</p>
                    <p class="text-sm text-green-500 mt-1">Tickets successfully resolved.</p>
                </div>
                <div class="bg-yellow-50 p-6 rounded-lg shadow hover:shadow-md transition-shadow">
                    <h3 class="text-lg font-medium text-yellow-700">Pending Your Reply</h3>
                    <p class="text-3xl font-bold text-yellow-600 mt-2" id="statPendingReply">1</p>
                    <p class="text-sm text-yellow-500 mt-1">Tickets needing your input.</p>
                </div>
            </div>
            <div class="mt-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Quick Actions</h3>
                <div class="flex space-x-4">
                    <button data-target="newTicket" class="nav-link-action bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out">
                        Create New Ticket
                    </button>
                    <button data-target="knowledgeBase" class="nav-link-action bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out">
                        Search Knowledge Base
                    </button>
                </div>
            </div>
        </section>

        <section id="myTickets" class="content-section hidden bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">My Submitted Tickets</h2>
            <div class="overflow-x-auto custom-scrollbar">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Updated</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
             <p id="noTicketsMessage" class="text-center text-gray-500 py-8 hidden">You have not submitted any tickets yet.</p>
        </section>

        <section id="newTicket" class="content-section hidden bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Submit a New Ticket</h2>
            <form id="newTicketForm" class="space-y-6">
                <div>
                    <label for="ticketSubject" class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                    <input type="text" name="ticketSubject" id="ticketSubject" required class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" placeholder="e.g., Cannot connect to WiFi">
                </div>
                <div>
                    <label for="ticketCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="ticketCategory" name="ticketCategory" required class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out bg-white">
                        <option value="">Select a category...</option>
                    </select>
                </div>
                <div>
                    <label for="ticketPriority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                    <select id="ticketPriority" name="ticketPriority" required class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out bg-white">
                        <option value="">Select priority...</option>
                    </select>
                </div>
                <div>
                    <label for="ticketDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="ticketDescription" name="ticketDescription" rows="5" required class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" placeholder="Please provide as much detail as possible..."></textarea>
                </div>
                <div>
                    <label for="ticketAttachments" class="block text-sm font-medium text-gray-700 mb-1">Attachments (Optional)</label>
                    <input type="file" name="ticketAttachments" id="ticketAttachments" multiple class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>
                <div>
                    <button type="submit" class="w-full sm:w-auto flex items-center justify-center py-2.5 px-5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Submit Ticket
                    </button>
                </div>
            </form>
            <div id="newTicketMessage" class="mt-4"></div>
        </section>

        <section id="knowledgeBase" class="content-section hidden bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Knowledge Base</h2>
            <div class="mb-6">
                <label for="kbSearch" class="block text-sm font-medium text-gray-700 mb-1">Search Articles</label>
                <div class="relative">
                    <input type="search" name="kbSearch" id="kbSearch" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" placeholder="Search by keyword, e.g., password reset">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
            </div>
            <div id="kbArticlesList" class="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                </div>
            <p id="noKbArticlesMessage" class="text-center text-gray-500 py-8 hidden">No articles found matching your search.</p>
        </section>
    </main>

    <footer class="bg-gray-800 text-white text-center p-4 mt-auto">
        <p class="text-sm">&copy; <span id="currentYear"></span> Your IT Department. All rights reserved.</p>
    </footer>

    <div id="detailsModal" class="modal">
        <div class="modal-content custom-scrollbar max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-xl font-semibold text-gray-800">Details</h3>
                <button id="modalCloseButton" class="text-gray-500 hover:text-gray-700 modal-close-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="modalBody" class="text-gray-700 space-y-4">
                </div>
        </div>
    </div>


    <script>
        // Mock Data (simulating data from your SQLite schema)
        const mockUser = {
            userId: 101,
            fullName: "Jane Doe", // From Users table
            email: "jane.doe@example.com" // From Users table
        };

        const mockTicketStatuses = [ // From Ticket_Statuses table
            { status_id: 1, status_name: 'Open', is_closing_status: 0 },
            { status_id: 2, status_name: 'In Progress', is_closing_status: 0 },
            { status_id: 3, status_name: 'Pending User Reply', is_closing_status: 0 },
            { status_id: 4, status_name: 'Resolved', is_closing_status: 1 },
            { status_id: 5, status_name: 'Closed', is_closing_status: 1 }
        ];

        const mockTicketPriorities = [ // From Ticket_Priorities table
            { priority_id: 1, priority_name: 'Urgent', sort_order: 1 },
            { priority_id: 2, priority_name: 'High', sort_order: 2 },
            { priority_id: 3, priority_name: 'Medium', sort_order: 3 },
            { priority_id: 4, priority_name: 'Low', sort_order: 4 }
        ];

        const mockTicketCategories = [ // From Ticket_Categories table
            { category_id: 1, category_name: 'Hardware Issue' },
            { category_id: 2, category_name: 'Software Problem' },
            { category_id: 3, category_name: 'Network Access' },
            { category_id: 4, category_name: 'Password Reset' },
            { category_id: 5, category_name: 'Account Management' }
        ];

        let mockTickets = [ // From Tickets table (filtered for current user)
            { ticket_id: 2024001, subject: 'Laptop screen flickering', description: 'My laptop screen started flickering this morning. It happens intermittently.', status_id: 2, priority_id: 2, category_id: 1, requester_id: 101, created_at: '2024-05-01T10:00:00Z', updated_at: '2024-05-03T14:30:00Z', comments: [{user: 'Support Agent', text: 'We are looking into this issue.', date: '2024-05-02T11:00:00Z'}]},
            { ticket_id: 2024002, subject: 'Cannot access shared drive', description: 'I am unable to access the marketing shared drive. I get an access denied error.', status_id: 1, priority_id: 3, category_id: 3, requester_id: 101, created_at: '2024-05-03T09:15:00Z', updated_at: '2024-05-03T09:15:00Z', comments: []},
            { ticket_id: 2024003, subject: 'Request for new software license', description: 'I need a license for Adobe Photoshop for a new project.', status_id: 4, priority_id: 4, category_id: 2, requester_id: 101, created_at: '2024-04-20T15:00:00Z', updated_at: '2024-04-25T10:00:00Z', resolved_at: '2024-04-25T10:00:00Z', comments: [{user: 'Support Agent', text: 'License has been approved and assigned.', date: '2024-04-25T10:00:00Z'}]},
            { ticket_id: 2024004, subject: 'Email not syncing on phone', description: 'My work emails are not syncing to my mobile device since yesterday.', status_id: 3, priority_id: 2, category_id: 5, requester_id: 101, created_at: '2024-05-05T11:00:00Z', updated_at: '2024-05-06T09:00:00Z', comments: [{user: 'Support Agent', text: 'Could you please confirm your device model and OS version?', date: '2024-05-06T09:00:00Z'}]},
        ];

        const mockKbArticles = [ // From KB_Articles table
            { article_id: 101, title: 'How to Reset Your Password', content: '<p>If you have forgotten your password, you can reset it by following these steps:</p><ol class="list-decimal list-inside space-y-1"><li>Go to the login page.</li><li>Click on the "Forgot Password" link.</li><li>Enter your email address and follow the instructions sent to your inbox.</li></ol><p>If you still face issues, please contact IT support.</p>', kb_category_id: 4, helpful_votes: 15, not_helpful_votes: 2, tags: ['password', 'reset', 'account'] },
            { article_id: 102, title: 'Setting Up VPN Access', content: '<p>To access company resources remotely, you need to set up the VPN. Download the VPN client from the IT portal and follow the installation guide specific to your operating system.</p><p><strong>Common Issues:</strong></p><ul class="list-disc list-inside space-y-1"><li>Ensure you have a stable internet connection.</li><li>Verify your credentials.</li></ul>', kb_category_id: 3, helpful_votes: 25, not_helpful_votes: 1, tags: ['vpn', 'network', 'remote access'] },
            { article_id: 103, title: 'Troubleshooting Printer Issues', content: '<p>Common printer problems and their solutions:</p><ul class="list-disc list-inside space-y-1"><li><strong>Printer Offline:</strong> Check power and network cables. Restart the printer and your computer.</li><li><strong>Paper Jam:</strong> Carefully remove jammed paper following printer instructions.</li><li><strong>Low Toner:</strong> Replace the toner cartridge.</li></ul>', kb_category_id: 1, helpful_votes: 18, not_helpful_votes: 3, tags: ['printer', 'hardware', 'troubleshooting'] },
            { article_id: 104, title: 'Requesting New Software', content: '<p>To request new software, please submit a "Software Problem" ticket with the following details:</p><ul class="list-disc list-inside space-y-1"><li>Software Name and Version</li><li>Business Justification</li><li>Project it is needed for (if applicable)</li></ul><p>Your request will be reviewed by the IT department.</p>', kb_category_id: 2, helpful_votes: 10, not_helpful_votes: 0, tags: ['software', 'request', 'license'] }
        ];

        // Utility to get names from IDs
        const getStatusName = (id) => mockTicketStatuses.find(s => s.status_id === id)?.status_name || 'Unknown';
        const getPriorityName = (id) => mockTicketPriorities.find(p => p.priority_id === id)?.priority_name || 'Unknown';
        const getCategoryName = (id) => mockTicketCategories.find(c => c.category_id === id)?.category_name || 'Unknown';
        const getKbCategoryName = (id) => mockTicketCategories.find(c => c.category_id === id)?.category_name || 'Uncategorized'; // Assuming KB uses same categories for simplicity

        // DOM Elements
        const contentSections = document.querySelectorAll('.content-section');
        const navLinks = document.querySelectorAll('nav button[data-target], button.nav-link-action[data-target]');
        const ticketsTableBody = document.getElementById('ticketsTableBody');
        const noTicketsMessage = document.getElementById('noTicketsMessage');
        const newTicketForm = document.getElementById('newTicketForm');
        const newTicketMessage = document.getElementById('newTicketMessage');
        const ticketCategorySelect = document.getElementById('ticketCategory');
        const ticketPrioritySelect = document.getElementById('ticketPriority');
        const kbSearchInput = document.getElementById('kbSearch');
        const kbArticlesList = document.getElementById('kbArticlesList');
        const noKbArticlesMessage = document.getElementById('noKbArticlesMessage');
        const modal = document.getElementById('detailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalCloseButton = document.getElementById('modalCloseButton');

        // --- Initialization ---
        function initializeDashboard() {
            // Set user name
            document.getElementById('userName').textContent = mockUser.fullName;
            // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            // Populate dropdowns
            populateSelect(ticketCategorySelect, mockTicketCategories, 'category_id', 'category_name');
            populateSelect(ticketPrioritySelect, mockTicketPriorities, 'priority_id', 'priority_name');

            // Load initial view (Home)
            showSection('dashboardHome');
            updateActiveNav('dashboardHome');

            // Render initial data
            renderTickets();
            renderKbArticles();
            updateDashboardStats();

            // Add event listeners
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const targetId = link.dataset.target;
                    showSection(targetId);
                    updateActiveNav(targetId); // Update active state for main nav only
                });
            });

            newTicketForm.addEventListener('submit', handleNewTicketSubmit);
            kbSearchInput.addEventListener('input', () => renderKbArticles(kbSearchInput.value.toLowerCase()));

            // Modal listeners
            modalCloseButton.addEventListener('click', closeModal);
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeModal();
                }
            });
        }

        // --- Navigation & Section Handling ---
        function showSection(sectionId) {
            contentSections.forEach(section => {
                section.classList.add('hidden');
            });
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.remove('hidden');
            }
        }

        function updateActiveNav(targetId) {
            // Only update for the main navigation bar buttons
            const mainNavLinks = document.querySelectorAll('nav button[data-target]');
            mainNavLinks.forEach(navLink => {
                if (navLink.dataset.target === targetId) {
                    navLink.classList.add('nav-link-active');
                } else {
                    navLink.classList.remove('nav-link-active');
                }
            });
        }

        // --- Data Rendering ---
        function populateSelect(selectElement, data, valueKey, textKey) {
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = item[textKey];
                selectElement.appendChild(option);
            });
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function renderTickets() {
            ticketsTableBody.innerHTML = ''; // Clear existing rows
            const userTickets = mockTickets.filter(t => t.requester_id === mockUser.userId).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            if (userTickets.length === 0) {
                noTicketsMessage.classList.remove('hidden');
                ticketsTableBody.parentElement.classList.add('hidden'); // Hide table if no tickets
                return;
            }
            
            noTicketsMessage.classList.add('hidden');
            ticketsTableBody.parentElement.classList.remove('hidden');


            userTickets.forEach(ticket => {
                const row = ticketsTableBody.insertRow();
                row.className = "hover:bg-gray-50 transition-colors";
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${ticket.ticket_id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 max-w-xs truncate" title="${ticket.subject}">${ticket.subject}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${getCategoryName(ticket.category_id)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(ticket.status_id)}">
                            ${getStatusName(ticket.status_id)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${getPriorityName(ticket.priority_id)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(ticket.created_at)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(ticket.updated_at)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewTicketDetails(${ticket.ticket_id})" class="text-indigo-600 hover:text-indigo-900">View</button>
                    </td>
                `;
            });
        }
        
        function getStatusBadgeClass(statusId) {
            const statusName = getStatusName(statusId).toLowerCase();
            if (statusName.includes('resolved') || statusName.includes('closed')) return 'bg-green-100 text-green-800';
            if (statusName.includes('progress')) return 'bg-blue-100 text-blue-800';
            if (statusName.includes('pending')) return 'bg-yellow-100 text-yellow-800';
            return 'bg-gray-100 text-gray-800'; // Default for Open or others
        }


        function renderKbArticles(searchTerm = '') {
            kbArticlesList.innerHTML = ''; // Clear existing articles
            const filteredArticles = mockKbArticles.filter(article =>
                article.title.toLowerCase().includes(searchTerm) ||
                article.content.toLowerCase().includes(searchTerm) ||
                (article.tags && article.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
            );

            if (filteredArticles.length === 0) {
                noKbArticlesMessage.classList.remove('hidden');
                return;
            }
            noKbArticlesMessage.classList.add('hidden');

            filteredArticles.forEach(article => {
                const articleElement = document.createElement('div');
                articleElement.className = 'p-4 border border-gray-200 rounded-lg hover:shadow-md transition-shadow cursor-pointer';
                articleElement.innerHTML = `
                    <h4 class="text-lg font-semibold text-indigo-700 hover:text-indigo-800">${article.title}</h4>
                    <p class="text-sm text-gray-600 mt-1">Category: ${getKbCategoryName(article.kb_category_id)}</p>
                    <p class="text-sm text-gray-500 mt-2 truncate">${stripHtml(article.content).substring(0, 150)}...</p>
                    <div class="text-xs text-gray-400 mt-2">
                        Helpful: ${article.helpful_votes} | Not Helpful: ${article.not_helpful_votes}
                    </div>
                `;
                articleElement.addEventListener('click', () => viewKbArticleDetails(article.article_id));
                kbArticlesList.appendChild(articleElement);
            });
        }
        
        function stripHtml(html) {
           let tmp = document.createElement("DIV");
           tmp.innerHTML = html;
           return tmp.textContent || tmp.innerText || "";
        }

        function updateDashboardStats() {
            const openTickets = mockTickets.filter(t => !mockTicketStatuses.find(s => s.status_id === t.status_id)?.is_closing_status && t.status_id !== 3).length; // Exclude pending user reply
            const resolvedTickets = mockTickets.filter(t => mockTicketStatuses.find(s => s.status_id === t.status_id)?.is_closing_status).length;
            const pendingReplyTickets = mockTickets.filter(t => t.status_id === 3).length; // Status ID 3 is 'Pending User Reply'

            document.getElementById('statOpenTickets').textContent = openTickets;
            document.getElementById('statResolvedTickets').textContent = resolvedTickets;
            document.getElementById('statPendingReply').textContent = pendingReplyTickets;
        }

        // --- Form Handling ---
        function handleNewTicketSubmit(event) {
            event.preventDefault();
            const subject = document.getElementById('ticketSubject').value;
            const categoryId = parseInt(document.getElementById('ticketCategory').value);
            const priorityId = parseInt(document.getElementById('ticketPriority').value);
            const description = document.getElementById('ticketDescription').value;
            // const attachments = document.getElementById('ticketAttachments').files; // Handle file uploads separately in a real app

            // Create new ticket object (mock)
            const newTicket = {
                ticket_id: Date.now(), // Simple unique ID for mock
                subject: subject,
                description: description,
                status_id: 1, // Default to 'Open'
                priority_id: priorityId,
                category_id: categoryId,
                requester_id: mockUser.userId,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
                comments: []
            };

            mockTickets.push(newTicket);
            renderTickets(); // Re-render ticket list
            updateDashboardStats(); // Update stats

            // Display success message
            newTicketMessage.innerHTML = `<div class="p-3 rounded-md bg-green-50 border border-green-300 text-green-700 text-sm">Ticket submitted successfully! (ID: ${newTicket.ticket_id})</div>`;
            newTicketForm.reset();
            setTimeout(() => { newTicketMessage.innerHTML = ''; }, 5000);

            // Optionally switch to "My Tickets" view
            // showSection('myTickets');
            // updateActiveNav('myTickets');
        }

        // --- Modal Functionality ---
        function openModal(title, contentHtml) {
            modalTitle.textContent = title;
            modalBody.innerHTML = contentHtml;
            modal.style.display = 'flex'; // Use flex to center content
            document.body.classList.add('overflow-hidden'); // Prevent background scroll
        }

        function closeModal() {
            modal.style.display = 'none';
            modalTitle.textContent = '';
            modalBody.innerHTML = '';
            document.body.classList.remove('overflow-hidden');
        }

        // --- View Details ---
        window.viewTicketDetails = function(ticketId) { // Make it global for inline onclick
            const ticket = mockTickets.find(t => t.ticket_id === ticketId);
            if (!ticket) return;

            let commentsHtml = '<h5 class="font-semibold mt-4 mb-2 text-gray-700">Comments:</h5>';
            if (ticket.comments && ticket.comments.length > 0) {
                commentsHtml += '<ul class="space-y-3 list-none pl-0">';
                ticket.comments.forEach(comment => {
                    commentsHtml += `
                        <li class="bg-gray-50 p-3 rounded-md border border-gray-200">
                            <p class="text-sm text-gray-800">${comment.text}</p>
                            <p class="text-xs text-gray-500 mt-1">By: ${comment.user} on ${formatDate(comment.date)}</p>
                        </li>`;
                });
                commentsHtml += '</ul>';
            } else {
                commentsHtml += '<p class="text-sm text-gray-500">No comments yet.</p>';
            }

            const content = `
                <div class="space-y-3">
                    <p><strong>ID:</strong> ${ticket.ticket_id}</p>
                    <p><strong>Subject:</strong> ${ticket.subject}</p>
                    <p><strong>Category:</strong> ${getCategoryName(ticket.category_id)}</p>
                    <p><strong>Status:</strong> <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(ticket.status_id)}">${getStatusName(ticket.status_id)}</span></p>
                    <p><strong>Priority:</strong> ${getPriorityName(ticket.priority_id)}</p>
                    <p><strong>Description:</strong></p>
                    <div class="p-3 bg-gray-50 border border-gray-200 rounded-md text-sm">${ticket.description || 'No description provided.'}</div>
                    <p><strong>Created:</strong> ${formatDate(ticket.created_at)}</p>
                    <p><strong>Last Updated:</strong> ${formatDate(ticket.updated_at)}</p>
                    ${ticket.resolved_at ? `<p><strong>Resolved:</strong> ${formatDate(ticket.resolved_at)}</p>` : ''}
                </div>
                ${commentsHtml}
                <div class="mt-6">
                    <h5 class="font-semibold mb-2 text-gray-700">Add a Comment:</h5>
                    <textarea id="newCommentText" rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="Type your reply..."></textarea>
                    <button onclick="addCommentToTicket(${ticket.ticket_id})" class="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md text-sm">Add Comment</button>
                </div>
            `;
            openModal(`Ticket Details: #${ticket.ticket_id}`, content);
        }
        
        window.addCommentToTicket = function(ticketId) {
            const commentText = document.getElementById('newCommentText').value;
            if (!commentText.trim()) {
                alert('Comment cannot be empty.'); // Replace with better UI later
                return;
            }
            const ticket = mockTickets.find(t => t.ticket_id === ticketId);
            if (ticket) {
                ticket.comments.push({
                    user: mockUser.fullName, // End user adds comment
                    text: commentText,
                    date: new Date().toISOString()
                });
                ticket.updated_at = new Date().toISOString();
                if (ticket.status_id === 3) { // If 'Pending User Reply'
                    ticket.status_id = 2; // Change to 'In Progress' or similar
                }
                renderTickets(); // Re-render tickets to reflect update
                updateDashboardStats();
                viewTicketDetails(ticketId); // Refresh modal content
            }
        }


        window.viewKbArticleDetails = function(articleId) { // Make it global
            const article = mockKbArticles.find(a => a.article_id === articleId);
            if (!article) return;

            const content = `
                <div class="prose prose-sm sm:prose lg:prose-lg xl:prose-xl max-w-none">
                    ${article.content}
                </div>
                <hr class="my-4">
                <div class="flex justify-between items-center text-sm">
                    <div>
                        <span class="text-gray-600">Category: ${getKbCategoryName(article.kb_category_id)}</span>
                    </div>
                    <div class="flex space-x-2">
                        <button class="text-green-600 hover:text-green-800 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a2 2 0 0 1 1.79 1.11L15 5.88Z"></path></svg>
                            Helpful (${article.helpful_votes})
                        </button>
                        <button class="text-red-600 hover:text-red-800 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M17 14V2"></path><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a2 2 0 0 1-1.79-1.11L9 18.12Z"></path></svg>
                            Not Helpful (${article.not_helpful_votes})
                        </button>
                    </div>
                </div>
                ${article.tags && article.tags.length > 0 ? `<div class="mt-3 text-sm text-gray-500">Tags: ${article.tags.map(tag => `<span class="bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full text-xs">${tag}</span>`).join(' ')}</div>` : ''}

            `;
            openModal(article.title, content);
        }

        // Run initialization when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>

</body>
</html>
